name: Test Deno Versions with R x64

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

jobs:
  test-deno-versions:
    runs-on: windows-11-arm
    strategy:
      fail-fast: false
      matrix:
        deno-version:
          - version: "2.4.5"
            description: "Quarto bundled version"
          - version: "2.5.0"
            description: "Released 2024-12-05"
          - version: "2.6.0"
            description: "Latest stable"
          - version: "latest"
            description: "Absolute latest"

    name: Deno ${{ matrix.deno-version.version }} (${{ matrix.deno-version.description }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Deno ${{ matrix.deno-version.version }}
        run: |
          Write-Host "Installing Deno ${{ matrix.deno-version.version }} (x64, like Quarto uses)..."

          if ("${{ matrix.deno-version.version }}" -eq "latest") {
            $version = gh api repos/denoland/deno/releases/latest --jq '.tag_name'
            Write-Host "Latest version: $version"
          } else {
            $version = "v${{ matrix.deno-version.version }}"
          }

          $downloadUrl = "https://github.com/denoland/deno/releases/download/$version/deno-x86_64-pc-windows-msvc.zip"
          Write-Host "Downloading: $downloadUrl"

          Invoke-WebRequest -Uri $downloadUrl -OutFile deno.zip -UseBasicParsing
          Expand-Archive -Path deno.zip -DestinationPath deno-install -Force

          $denoPath = Join-Path $PWD "deno-install\deno.exe"
          Write-Host "Deno installed at: $denoPath"
          & $denoPath --version
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify R x64 installation
        run: |
          Rscript -e "cat('R Platform:', R.version[['platform']], '\n')"
          Rscript -e "cat('R Version:', R.version[['version.string']], '\n')"

      - name: Install R packages
        run: |
          Rscript -e "install.packages(c('knitr', 'rmarkdown'), repos='https://cloud.r-project.org')"

      - name: Test Deno ${{ matrix.deno-version.version }} with simple R script
        id: test-simple
        continue-on-error: true
        run: |
          Write-Host "========================================="
          Write-Host "Test 1: Deno + Simple R script (no packages)"
          Write-Host "========================================="

          $denoPath = Join-Path $PWD "deno-install\deno.exe"
          $rscriptPath = (Get-Command Rscript).Source

          & $denoPath run --allow-run --allow-read test-deno-rscript.ts $rscriptPath test-simple.R
          $exitCode = $LASTEXITCODE

          if ($exitCode -ne 0) {
            Write-Host "::error::Deno ${{ matrix.deno-version.version }} + simple script FAILED (exit: $exitCode)"
            exit 1
          } else {
            Write-Host "::notice::✅ Deno ${{ matrix.deno-version.version }} + simple script SUCCEEDED"
            exit 0
          }

      - name: Test Deno ${{ matrix.deno-version.version }} with knitr script
        id: test-knitr
        continue-on-error: true
        run: |
          Write-Host "========================================="
          Write-Host "Test 2: Deno + R script loading knitr"
          Write-Host "========================================="

          $denoPath = Join-Path $PWD "deno-install\deno.exe"
          $rscriptPath = (Get-Command Rscript).Source

          & $denoPath run --allow-run --allow-read test-deno-rscript.ts $rscriptPath test-knitr.R
          $exitCode = $LASTEXITCODE

          if ($exitCode -ne 0) {
            Write-Host "::warning::❌ Deno ${{ matrix.deno-version.version }} + knitr FAILED (exit: $exitCode) - Expected"
            exit 1
          } else {
            Write-Host "::notice::✅ Deno ${{ matrix.deno-version.version }} + knitr SUCCEEDED - Unexpected!"
            exit 0
          }

      - name: Test Deno ${{ matrix.deno-version.version }} with both packages
        id: test-both
        continue-on-error: true
        run: |
          Write-Host "========================================="
          Write-Host "Test 3: Deno + R script loading knitr+rmarkdown"
          Write-Host "========================================="
          Write-Host "(This mimics what Quarto does)"
          Write-Host ""

          $denoPath = Join-Path $PWD "deno-install\deno.exe"
          $rscriptPath = (Get-Command Rscript).Source

          & $denoPath run --allow-run --allow-read test-deno-rscript.ts $rscriptPath test-both.R
          $exitCode = $LASTEXITCODE

          if ($exitCode -ne 0) {
            Write-Host "::warning::❌ Deno ${{ matrix.deno-version.version }} + both packages FAILED (exit: $exitCode) - Expected"
            exit 1
          } else {
            Write-Host "::notice::✅ Deno ${{ matrix.deno-version.version }} + both packages SUCCEEDED - Unexpected!"
            exit 0
          }

      - name: Summary for Deno ${{ matrix.deno-version.version }}
        if: always()
        run: |
          Write-Host ""
          Write-Host "========================================="
          Write-Host "Summary: Deno ${{ matrix.deno-version.version }}"
          Write-Host "========================================="
          Write-Host "Expected: Simple scripts succeed, package-loading scripts fail"
          Write-Host "This proves issue is script-specific, not Deno version-specific"

  summary:
    runs-on: windows-11-arm
    needs: test-deno-versions
    if: always()
    steps:
      - name: Summary
        run: |
          Write-Host "Deno version testing complete."
          Write-Host "Check individual job results to see which versions work with R x64 on Windows ARM."
