name: Test bslib Hypothesis

on:
  push:
    branches: [main]
    paths:
      - 'test-bslib-*.R'
      - 'test-rmarkdown-minimal.R'
      - '.github/workflows/test-bslib-hypothesis.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-bslib-only:
    name: "Test 1: bslib in isolation"
    runs-on: windows-11-arm
    outputs:
      exit_code: ${{ steps.test.outputs.exit_code }}
    steps:
      - uses: actions/checkout@v4

      - name: Verify R x64 (default on runner)
        shell: pwsh
        run: |
          Write-Host "Verifying R x64 platform..."
          $platform = Rscript -e "cat(R.version[['platform']])"
          Write-Host "Platform: $platform"
          $version = Rscript -e "cat(R.version[['version.string']])"
          Write-Host "R version: $version"
          if ($platform -notmatch 'x86_64') {
            Write-Error "Expected x86_64 platform, got: $platform"
            exit 1
          }
          Write-Host "✓ Confirmed R x64 on Windows ARM"

      - name: Install bslib
        shell: pwsh
        run: |
          Rscript -e "if (!require('bslib', quietly = TRUE)) install.packages('bslib', repos = 'https://cloud.r-project.org')"

      - name: Run test-bslib-only.R
        id: test
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "Running test-bslib-only.R..."
          Write-Host ""
          $output = Rscript test-bslib-only.R 2>&1
          $exitCode = $LASTEXITCODE
          Write-Host "Output:"
          Write-Host $output
          Write-Host ""
          Write-Host "Exit code: $exitCode"

          # Save exit code for summary
          echo "exit_code=$exitCode" >> $env:GITHUB_OUTPUT

          if ($exitCode -eq -1073741569) {
            Write-Host "Detected STATUS_NOT_SUPPORTED crash"
          }

      - name: Analyze result
        shell: pwsh
        run: |
          $exitCode = '${{ steps.test.outputs.exit_code }}'
          Write-Host "Test exit code: $exitCode"
          Write-Host ""
          if ($exitCode -eq '-1073741569' -or $exitCode -ne '0') {
            Write-Host "❌ bslib test FAILED (exit code: $exitCode)"
            Write-Host "This confirms bslib alone causes the crash."
          } else {
            Write-Host "✅ bslib test PASSED"
            Write-Host "This suggests bslib is NOT the root cause."
          }

  test-bslib-deps:
    name: "Test 2: bslib dependencies"
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install bslib dependencies
        shell: pwsh
        run: |
          $deps = @('sass', 'jquerylib', 'htmltools', 'rlang', 'fastmap', 'cachem', 'memoise')
          foreach ($pkg in $deps) {
            Write-Host "Installing $pkg..."
            Rscript -e "if (!require('$pkg', quietly = TRUE)) install.packages('$pkg', repos = 'https://cloud.r-project.org')"
          }

      - name: Run test-bslib-deps.R
        id: test
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "Running test-bslib-deps.R..."
          Write-Host ""
          $result = Rscript test-bslib-deps.R
          $exitCode = $LASTEXITCODE
          Write-Host "Output:"
          Write-Host $result
          Write-Host ""
          Write-Host "Exit code: $exitCode"
          exit $exitCode

      - name: Analyze result
        shell: pwsh
        run: |
          $exitCode = '${{ steps.test.outcome }}'
          Write-Host "Test outcome: $exitCode"
          Write-Host ""
          if ($exitCode -eq 'failure') {
            Write-Host "❌ bslib deps test FAILED (unexpected)"
            Write-Host "Phase 1 testing proved all dependencies work individually."
          } else {
            Write-Host "✅ bslib deps test PASSED (expected)"
            Write-Host "Confirms dependencies work when loaded separately."
          }

  test-rmarkdown-minimal:
    name: "Test 3: minimal rmarkdown"
    runs-on: windows-11-arm
    outputs:
      exit_code: ${{ steps.test.outputs.exit_code }}
    steps:
      - uses: actions/checkout@v4

      - name: Install rmarkdown
        shell: pwsh
        run: |
          Rscript -e "if (!require('rmarkdown', quietly = TRUE)) install.packages('rmarkdown', repos = 'https://cloud.r-project.org')"

      - name: Run test-rmarkdown-minimal.R
        id: test
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "Running test-rmarkdown-minimal.R..."
          Write-Host ""
          $output = Rscript test-rmarkdown-minimal.R 2>&1
          $exitCode = $LASTEXITCODE
          Write-Host "Output:"
          Write-Host $output
          Write-Host ""
          Write-Host "Exit code: $exitCode"

          # Save exit code for summary
          echo "exit_code=$exitCode" >> $env:GITHUB_OUTPUT

          if ($exitCode -eq -1073741569) {
            Write-Host "Detected STATUS_NOT_SUPPORTED crash"
          }

      - name: Analyze result
        shell: pwsh
        run: |
          $exitCode = '${{ steps.test.outputs.exit_code }}'
          Write-Host "Test exit code: $exitCode"
          Write-Host ""
          if ($exitCode -eq '-1073741569' -or $exitCode -ne '0') {
            Write-Host "❌ rmarkdown minimal test FAILED (exit code: $exitCode)"
            Write-Host "This confirms rmarkdown loading triggers the crash."
            Write-Host ""
            Write-Host "Check output for which packages were loaded."
          } else {
            Write-Host "✅ rmarkdown minimal test PASSED"
            Write-Host "This is unexpected - rmarkdown should crash."
          }

  summary:
    name: "Test Results Summary"
    runs-on: ubuntu-latest
    needs: [test-bslib-only, test-bslib-deps, test-rmarkdown-minimal]
    if: always()
    steps:
      - name: Summary
        shell: bash
        run: |
          echo "## bslib Hypothesis Test Results"
          echo ""
          echo "| Test | Exit Code | Status |"
          echo "|------|-----------|--------|"

          # Test 1: bslib only
          test1_exit="${{ needs.test-bslib-only.outputs.exit_code }}"
          if [ "$test1_exit" == "-1073741569" ] || [ "$test1_exit" != "0" ]; then
            test1_status="❌ CRASHED"
          else
            test1_status="✅ PASSED"
          fi
          echo "| bslib only | $test1_exit | $test1_status |"

          # Test 2: bslib deps (always uses conclusion since it just loads packages)
          if [ '${{ needs.test-bslib-deps.result }}' == 'success' ]; then
            test2_status="✅ PASSED"
            test2_exit="0"
          else
            test2_status="❌ FAILED"
            test2_exit="non-zero"
          fi
          echo "| bslib deps | $test2_exit | $test2_status |"

          # Test 3: rmarkdown minimal
          test3_exit="${{ needs.test-rmarkdown-minimal.outputs.exit_code }}"
          if [ "$test3_exit" == "-1073741569" ] || [ "$test3_exit" != "0" ]; then
            test3_status="❌ CRASHED"
          else
            test3_status="✅ PASSED"
          fi
          echo "| rmarkdown minimal | $test3_exit | $test3_status |"

          echo ""
          echo "### Hypothesis Validation"
          echo ""

          # Check if bslib hypothesis is confirmed
          if [ "$test1_exit" == "-1073741569" ] && \
             [ '${{ needs.test-bslib-deps.result }}' == 'success' ] && \
             [ "$test3_exit" == "-1073741569" ]; then
            echo "✅ **bslib hypothesis CONFIRMED**"
            echo ""
            echo "Evidence:"
            echo "- ❌ bslib alone crashes (exit -1073741569)"
            echo "- ✅ bslib dependencies work separately"
            echo "- ❌ rmarkdown (which loads bslib) crashes (exit -1073741569)"
            echo ""
            echo "**Conclusion**: bslib's global state management is the root cause."
          elif [ "$test1_exit" == "0" ] && [ "$test3_exit" == "-1073741569" ]; then
            echo "❌ **bslib hypothesis REJECTED**"
            echo ""
            echo "**Evidence:**"
            echo "- ✅ bslib alone works fine"
            echo "- ❌ rmarkdown still crashes WITHOUT bslib being loaded"
            echo ""
            echo "**Critical finding**: The crash occurs even when bslib is not loaded."
            echo ""
            echo "**Next steps**: Investigate alternative hypotheses:"
            echo "- setHook() persistence in rmarkdown's .onLoad"
            echo "- Combination of packages (htmltools + xfun + evaluate + knitr)"
            echo "- Temporary file cleanup (clean_tmpfiles)"
            echo "- Namespace binding manipulation (unlockBinding)"
          else
            echo "⚠️ **Inconclusive or mixed results**"
            echo ""
            echo "Exit codes:"
            echo "- Test 1 (bslib only): $test1_exit"
            echo "- Test 3 (rmarkdown): $test3_exit"
            echo ""
            echo "Review individual test logs for details."
          fi
